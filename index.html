<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerPricing | ConEd Bill Estimator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --google-blue: #4285f4; }
        .card { @apply bg-white p-6 rounded-xl shadow-sm border border-gray-100; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans leading-relaxed">

<div id="app" class="max-w-md mx-auto min-h-screen flex flex-col p-4">
    <header class="mb-6 pt-2 text-center">
        <div class="bg-amber-50 border border-amber-100 rounded-lg p-3 mb-4 text-[11px] text-amber-800 leading-snug">
            <span class="font-bold">‚ö†Ô∏è Disclaimer:</span> Vibe-coded by a ConEd customer while making breakfast. No guarantee of accuracy, use at your own risk!
        </div>
        <h1 class="text-2xl font-bold text-gray-800">PowerPricing</h1>
        <p class="text-sm text-gray-500 font-medium">ConEd NYC 2026 Bill Estimator</p>
    </header>

    <main class="space-y-6 flex-grow">
        <section class="card">
            <h2 class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-4">Usage Profile</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Billing Month</label>
                    <select id="billMonth" class="w-full p-2 bg-gray-50 border rounded-md font-sans text-sm">
                        <option value="0">January</option><option value="1">February</option>
                        <option value="2">March</option><option value="3">April</option>
                        <option value="4">May</option><option value="5">June</option>
                        <option value="6">July</option><option value="7">August</option>
                        <option value="8">September</option><option value="9">October</option>
                        <option value="10">November</option><option value="11">December</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Total Energy (kWh)</label>
                    <input type="number" id="totalKwh" value="6547" class="w-full p-2 bg-gray-50 border rounded-md font-mono text-lg">
                </div>
                <div>
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">On-Peak kWh</label>
                    <input type="number" id="onPeakKwh" value="1344" class="w-full p-2 bg-gray-50 border rounded-md font-mono text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Off-Peak kWh</label>
                    <input type="number" id="offPeakKwh" value="5203" class="w-full p-2 bg-gray-50 border rounded-md font-mono text-sm">
                </div>
                <div class="col-span-2">
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Peak Demand (kW)</label>
                    <input type="number" id="peakKw" value="15.77" step="0.01" class="w-full p-2 bg-gray-50 border rounded-md font-mono text-sm">
                </div>
            </div>
        </section>

        <section class="card overflow-hidden !p-0">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 border-b">
                    <tr>
                        <th class="p-3 text-[10px] font-bold text-gray-500 uppercase">Itemized</th>
                        <th class="p-3 text-[10px] font-bold text-gray-500 uppercase text-right">Standard</th>
                        <th class="p-3 text-[10px] font-bold text-gray-500 uppercase text-right">Select</th>
                    </tr>
                </thead>
                <tbody class="divide-y text-xs">
                    <tr>
                        <td class="p-3 text-gray-600 font-medium">Delivery</td>
                        <td id="stdDel" class="p-3 text-right font-mono text-gray-500">--</td>
                        <td id="selDel" class="p-3 text-right font-mono text-blue-600">--</td>
                    </tr>
                    <tr>
                        <td class="p-3 text-gray-600 font-medium">Supply</td>
                        <td id="stdSup" class="p-3 text-right font-mono text-gray-500">--</td>
                        <td id="selSup" class="p-3 text-right font-mono text-blue-600">--</td>
                    </tr>
                    <tr class="bg-gray-50/50 font-bold">
                        <td class="p-3 text-gray-800">Total Bill</td>
                        <td id="stdTotal" class="p-3 text-right font-mono text-gray-800 text-sm">--</td>
                        <td id="selTotal" class="p-3 text-right font-mono text-blue-700 text-sm">--</td>
                    </tr>
                    <tr class="text-[9px] text-gray-400">
                        <td class="p-3 italic uppercase">Effective $/kWh</td>
                        <td id="stdEff" class="p-3 text-right font-mono">--</td>
                        <td id="selEff" class="p-3 text-right font-mono">--</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section id="savingsCard" class="card bg-green-50 border-green-100 text-center">
            <h2 class="text-[10px] font-bold uppercase text-green-600 mb-1">Estimated Savings</h2>
            <div id="savingsAmount" class="text-4xl font-black text-green-700">--</div>
            <p id="savingsPercent" class="text-xs font-bold text-green-600 mt-1 uppercase tracking-tight">--</p>
        </section>

        <section id="yearlyCard" class="card border-dashed border-2 border-gray-200 bg-gray-50/50">
            <h2 class="text-[10px] font-bold uppercase text-gray-400 mb-2">Annual Projection</h2>
            <div class="flex justify-between items-end">
                <div>
                    <div id="yearlyStd" class="text-xs text-gray-400 line-through">--</div>
                    <div id="yearlySel" class="text-2xl font-black text-gray-800 tracking-tight">--</div>
                </div>
                <div id="yearlySavings" class="text-right text-[10px] font-black text-green-600 pb-1 border-b-2 border-green-200">--</div>
            </div>
            <p class="text-[9px] text-gray-400 mt-3 leading-tight italic">Projection based on seasonal scaling from your 2025 heat-pump usage history.</p>
        </section>
    </main>

    <footer class="py-8 text-center space-y-4">
        <button id="testBtn" class="text-[10px] text-gray-300 hover:text-gray-500 underline">Run Validation Tests</button>
        <div class="flex flex-col items-center gap-2 border-t border-gray-100 pt-6">
            <a href="https://github.com/tulrich/powerpricing" target="_blank" class="flex items-center gap-2 text-xs text-gray-500 hover:text-gray-800">
                <span>View on GitHub</span>
            </a>
        </div>
    </footer>
</div>

<script type="module">
    /** @const */
    const SEASON_WEIGHTS = [0.144, 0.124, 0.076, 0.048, 0.030, 0.041, 0.054, 0.038, 0.033, 0.050, 0.094, 0.171];
    
    /** @const */
    const CONST = {
        SC1_STD_FIXED: 20.00, SC1_SEL_FIXED: 30.28, SBC_RATE: 0.0051, TAX_MULT: 1.071,
        STD_DELIVERY_KWH: 0.165, SEL_DELIVERY_KWH: 0.0098,
        WINTER_DEMAND: 20.25, SUMMER_DEMAND: 26.50,
        SUPPLY_STD: 0.1415, SUPPLY_SEL_ON: 0.205, SUPPLY_SEL_OFF: 0.125
    };

    const state = new Proxy({
        totalKwh: 6547, onPeakKwh: 1344, offPeakKwh: 5203, peakKw: 15.77, billMonth: 0
    }, {
        set(target, prop, value) {
            const num = parseFloat(value) || 0;
            target[prop] = num;
            if (prop === 'totalKwh') {
                target.onPeakKwh = Math.round(num * 0.205);
                target.offPeakKwh = num - target.onPeakKwh;
                document.getElementById('onPeakKwh').value = target.onPeakKwh;
                document.getElementById('offPeakKwh').value = target.offPeakKwh;
            }
            syncToUrl();
            render();
            return true;
        }
    });

    function calculate(usage, monthIdx) {
        const isSummer = monthIdx >= 5 && monthIdx <= 8;
        const demandRate = isSummer ? CONST.SUMMER_DEMAND : CONST.WINTER_DEMAND;
        const stdDel = CONST.SC1_STD_FIXED + (usage.totalKwh * (CONST.STD_DELIVERY_KWH + CONST.SBC_RATE));
        const stdSup = usage.totalKwh * CONST.SUPPLY_STD;
        const selDel = CONST.SC1_SEL_FIXED + (usage.totalKwh * (CONST.SEL_DELIVERY_KWH + CONST.SBC_RATE)) + (usage.peakKw * demandRate);
        const selSup = (usage.onPeakKwh * CONST.SUPPLY_SEL_ON) + (usage.offPeakKwh * CONST.SUPPLY_SEL_OFF);
        return { 
            stdTotal: (stdDel + stdSup) * CONST.TAX_MULT, 
            selTotal: (selDel + selSup) * CONST.TAX_MULT,
            stdDel, stdSup, selDel, selSup 
        };
    }

    function render() {
        const cur = calculate(state, state.billMonth);
        const savings = cur.stdTotal - cur.selTotal;
        const fmt = (v) => `$${v.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        
        document.getElementById('stdDel').textContent = fmt(cur.stdDel);
        document.getElementById('stdSup').textContent = fmt(cur.stdSup);
        document.getElementById('stdTotal').textContent = fmt(cur.stdTotal);
        document.getElementById('stdEff').textContent = `$${(cur.stdTotal / (state.totalKwh || 1)).toFixed(3)}`;
        document.getElementById('selDel').textContent = fmt(cur.selDel);
        document.getElementById('selSup').textContent = fmt(cur.selSup);
        document.getElementById('selTotal').textContent = fmt(cur.selTotal);
        document.getElementById('selEff').textContent = `$${(cur.selTotal / (state.totalKwh || 1)).toFixed(3)}`;
        document.getElementById('savingsAmount').textContent = fmt(Math.abs(savings));
        document.getElementById('savingsPercent').textContent = `${((savings/cur.stdTotal)*100).toFixed(1)}% SAVINGS VS STANDARD`;

        let yearStd = 0, yearSel = 0;
        const baseW = SEASON_WEIGHTS[state.billMonth];
        SEASON_WEIGHTS.forEach((w, i) => {
            const r = w / baseW;
            const est = calculate({
                totalKwh: state.totalKwh * r, onPeakKwh: state.onPeakKwh * r,
                offPeakKwh: state.offPeakKwh * r, peakKw: state.peakKw * Math.sqrt(r)
            }, i);
            yearStd += est.stdTotal;
            yearSel += est.selTotal;
        });

        document.getElementById('yearlyStd').textContent = `$${yearStd.toLocaleString(undefined, {maximumFractionDigits:0})}`;
        document.getElementById('yearlySel').textContent = `$${yearSel.toLocaleString(undefined, {maximumFractionDigits:0})} / YEAR`;
        document.getElementById('yearlySavings').textContent = `-$${(yearStd - yearSel).toLocaleString(undefined, {maximumFractionDigits:0})} ANNUAL SAVINGS`;
    }

    function syncToUrl() {
        const p = new URLSearchParams(state);
        window.history.replaceState(null, '', '#' + p.toString());
    }
    
    /**
     * Shadow Test Runner
     * Validates logic against Dec 2025 bill ($1,490.34) and 2025 History (~$7,713)
     */
    function runTests() {
        console.group('üõ† Validation Tests');
        
        // Test 1: Dec 2025 Bill Validation (State: 6547kWh, 15.77kW)
        const dec = calculate({totalKwh: 6547, onPeakKwh: 1344, offPeakKwh: 5203, peakKw: 15.77}, 0);
        const expectedDec = 1490.34;
        const decDiff = Math.abs(dec.selTotal - expectedDec);
        const decPass = decDiff < 1.0;
        
        console.assert(decPass, `Dec Bill mismatch! Expected: $${expectedDec}, Actual: $${dec.selTotal.toFixed(2)} (Diff: $${decDiff.toFixed(2)})`);

        // Test 2: Annual Estimate Validation
        let aStd = 0, aSel = 0;
        SEASON_WEIGHTS.forEach((w, i) => {
            const r = w / SEASON_WEIGHTS[0];
            const est = calculate({ 
                totalKwh: 6547 * r, 
                onPeakKwh: 1344 * r, 
                offPeakKwh: 5203 * r, 
                peakKw: 15.77 * Math.sqrt(r) 
            }, i);
            aStd += est.stdTotal; 
            aSel += est.selTotal;
        });

        const expectedAnnual = 7713;
        const annualDiff = Math.abs(aSel - expectedAnnual);
        const annualPass = annualDiff < 200; // Allowing for 2026 rate hike variance
        
        console.assert(annualPass, `Annual Projection mismatch! Expected: ~$${expectedAnnual}, Actual: $${aSel.toFixed(0)} (Diff: $${annualDiff.toFixed(0)})`);
        
        console.groupEnd();

        // Mobile-friendly alert with details
        const msg = decPass && annualPass ? "‚úÖ ALL TESTS PASSED" : "‚ùå VALIDATION FAILED";
        alert(`${msg}\n\nDECEMBER BILL:\nExpected: $${expectedDec}\nActual: $${dec.selTotal.toFixed(2)}\n\nANNUAL SELECT:\nExpected: ~$${expectedAnnual}\nActual: $${aSel.toFixed(0)}`);
    }

    // Initialization and Event Listeners
    window.onload = () => {
        const hash = window.location.hash.slice(1);
        if (hash) {
            const p = new URLSearchParams(hash);
            for (const [k, v] of p) {
                if (state.hasOwnProperty(k)) {
                    state[k] = v;
                    const el = document.getElementById(k);
                    if (el) el.value = v;
                }
            }
        }
        
        // Auto-run tests if ?test=true is in URL
        if (new URLSearchParams(window.location.search).get('test') === 'true') {
            runTests();
        }
        render();
    };

    // Bind all inputs defined in the state
    ['totalKwh', 'onPeakKwh', 'offPeakKwh', 'peakKw', 'billMonth'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', (e) => {
                state[id] = e.target.value;
            });
        }
    });

    document.getElementById('testBtn').onclick = runTests;
</script>
</body>
</html>
