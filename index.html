<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerPricing | ConEd Bill Estimator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root { --google-blue: #4285f4; }
        .card { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); border: 1px solid #f3f4f6; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans leading-relaxed">

<div id="app" class="max-w-md mx-auto min-h-screen flex flex-col p-4">
    <header class="mb-6 pt-2 text-center">
        <div class="bg-amber-50 border border-amber-100 rounded-lg p-3 mb-4 text-[11px] text-amber-800 leading-snug">
            <span class="font-bold">⚠️ Disclaimer:</span> Vibe-coded by a ConEd customer while making breakfast. No guarantee of accuracy, use at your own risk!
        </div>
        <h1 class="text-2xl font-bold text-gray-800">PowerPricing</h1>
        <p class="text-sm text-gray-500 font-medium">ConEd NYC 2026 Select Pricing Plan Estimator</p>
    </header>

    <main class="space-y-6 flex-grow">
        <section class="card">
            <h2 class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-4">Usage Profile</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Billing Month</label>
                    <select id="billMonth" class="w-full p-2 bg-gray-50 border rounded-md font-sans text-sm">
                        <option value="0">January</option><option value="1">February</option>
                        <option value="2">March</option><option value="3">April</option>
                        <option value="4">May</option><option value="5">June</option>
                        <option value="6">July</option><option value="7">August</option>
                        <option value="8">September</option><option value="9">October</option>
                        <option value="10">November</option>
                        <option value="11" selected>December</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Total Energy (kWh)</label>
                    <input type="number" id="totalKwh" value="3250" class="w-full p-2 bg-gray-50 border rounded-md font-mono text-lg">
                </div>
                <div>
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">On-Peak kWh</label>
                    <input type="number" id="onPeakKwh" value="666" class="w-full p-2 bg-gray-50 border rounded-md font-mono text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Off-Peak kWh</label>
                    <input type="number" id="offPeakKwh" value="2584" class="w-full p-2 bg-gray-50 border rounded-md font-mono text-sm">
                </div>
                
                <div>
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Peak Demand (kW)</label>
                    <input type="number" id="peakKw" value="7.6" step="0.1" class="w-full p-2 bg-gray-50 border rounded-md font-mono text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Off-Peak Demand (kW)</label>
                    <input type="number" id="peakKwOff" value="7.9" step="0.1" class="w-full p-2 bg-gray-50 border rounded-md font-mono text-sm">
                </div>
            </div>
        </section>

        <section class="card overflow-hidden !p-0">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 border-b">
                    <tr>
                        <th class="p-3 text-[10px] font-bold text-gray-500 uppercase">Itemized</th>
                        <th class="p-3 text-[10px] font-bold text-gray-500 uppercase text-right">Standard</th>
                        <th class="p-3 text-[10px] font-bold text-gray-500 uppercase text-right">Select</th>
                    </tr>
                </thead>
                <tbody class="divide-y text-xs">
                    <tr>
                        <td class="p-3 text-gray-600 font-medium">Delivery</td>
                        <td id="stdDel" class="p-3 text-right font-mono text-gray-500">--</td>
                        <td id="selDel" class="p-3 text-right font-mono text-blue-600">--</td>
                    </tr>
                    <tr>
                        <td class="p-3 text-gray-600 font-medium">Supply</td>
                        <td id="stdSup" class="p-3 text-right font-mono text-gray-500">--</td>
                        <td id="selSup" class="p-3 text-right font-mono text-blue-600">--</td>
                    </tr>
                    <tr class="bg-gray-50/50 font-bold">
                        <td class="p-3 text-gray-800">Total Bill</td>
                        <td id="stdTotal" class="p-3 text-right font-mono text-gray-800 text-sm">--</td>
                        <td id="selTotal" class="p-3 text-right font-mono text-blue-700 text-sm">--</td>
                    </tr>
                    <tr class="text-[9px] text-gray-400">
                        <td class="p-3 italic uppercase">Effective $/kWh</td>
                        <td id="stdEff" class="p-3 text-right font-mono">--</td>
                        <td id="selEff" class="p-3 text-right font-mono">--</td>
                    </tr>
                </tbody>
            </table>
            <div class="p-3 bg-gray-50 text-center border-t border-gray-100">
                <button onclick="toggleDetails()" class="text-[10px] font-bold text-blue-600 hover:text-blue-800 uppercase tracking-wider flex items-center justify-center gap-1 mx-auto">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    See Bill Details
                </button>
            </div>
        </section>

        <section id="savingsCard" class="card text-center transition-colors duration-300">
            <h2 id="savingsLabel" class="text-[10px] font-bold uppercase mb-1">Estimated Savings</h2>
            <div id="savingsAmount" class="text-4xl font-black">--</div>
            <p id="savingsPercent" class="text-xs font-bold mt-1 uppercase tracking-tight">--</p>
        </section>

        <section id="yearlyCard" class="card border-dashed border-2 border-gray-200 bg-gray-50/50">
            <h2 class="text-[10px] font-bold uppercase text-gray-400 mb-2">2026 Annual Projection</h2>
            <div class="h-48 mb-4">
                <canvas id="annualChart"></canvas>
            </div>
            <div class="flex justify-between items-end border-t border-gray-200 pt-3">
                <div>
                    <div id="yearlyStd" class="text-xs text-gray-400 line-through">--</div>
                    <div id="yearlySel" class="text-2xl font-black text-gray-800 tracking-tight">--</div>
                </div>
                <div id="yearlySavings" class="text-right text-[10px] font-black pb-1 border-b-2">--</div>
            </div>
            <p class="text-[9px] text-gray-400 mt-3 leading-tight italic">
                Extrapolated from <span id="baseMonthLabel" class="font-bold text-gray-500">December</span> profile.
            </p>
        </section>

        <div class="text-center">
            <a href="https://www.coned.com/en/accounts-billing/select-pricing-plan" target="_blank" class="inline-flex items-center gap-1 text-[10px] font-bold text-blue-600 hover:text-blue-800 uppercase tracking-wider bg-blue-50 px-3 py-1.5 rounded-full">
                <span>Learn about Select Pricing</span>
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
            </a>
        </div>
    </main>

    <footer class="py-8 text-center space-y-4">
        <div class="flex justify-center gap-4 text-[10px] text-gray-300">
            <button id="resetBtn" class="hover:text-gray-500 underline">Reset to Defaults</button>
            <span>|</span>
            <button id="testBtn" class="hover:text-gray-500 underline">Run Validation Tests</button>
        </div>
        <div class="flex flex-col items-center gap-2 border-t border-gray-100 pt-6">
            <a href="https://github.com/tulrich/powerpricing" target="_blank" class="flex items-center gap-2 text-xs text-gray-500 hover:text-gray-800">
                <span>View on GitHub</span>
            </a>
        </div>
    </footer>
</div>

<div id="detailsModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Bill Breakdown</h3>
                <button onclick="toggleDetails()" class="text-gray-400 hover:text-gray-600 p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <h4 class="text-xs font-bold uppercase text-blue-600 mb-2 border-b border-blue-100 pb-1">Select Pricing Plan</h4>
                    <div class="space-y-2 text-sm text-gray-600">
                        <div class="bg-blue-50/50 p-2 rounded-lg space-y-1 mb-2">
                            <div class="flex justify-between text-[11px] font-bold text-blue-800 uppercase tracking-wider mb-1">Demand Charges</div>
                            <div class="flex justify-between">
                                <span>Peak Demand</span>
                                <span id="dtlSelDemandRate" class="text-[10px] text-gray-400 mt-0.5">-- kW @ $19.50</span>
                                <span id="dtlSelDemandTotal" class="font-mono font-bold text-blue-700">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Off-Peak Demand</span>
                                <span id="dtlSelDemandOffRate" class="text-[10px] text-gray-400 mt-0.5">-- kW @ $7.48</span>
                                <span id="dtlSelDemandOffTotal" class="font-mono font-bold text-blue-700">--</span>
                            </div>
                        </div>

                        <div class="space-y-1">
                            <div class="flex justify-between">
                                <span>Basic Service Charge</span>
                                <span id="dtlSelFixed" class="font-mono">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Delivery & SBC</span>
                                <span id="dtlSelDelVol" class="font-mono">--</span>
                            </div>
                            <div class="flex justify-between text-[10px] text-gray-400 pl-2">
                                <span>(Delivery 0.98¢ + SBC 0.47¢)</span>
                            </div>
                            <div class="flex justify-between border-t border-dashed border-gray-200 pt-1">
                                <span>Taxes & Surcharges (~9.5%)</span>
                                <span id="dtlSelDelTax" class="font-mono text-gray-500">--</span>
                            </div>
                            <div class="flex justify-between font-bold text-gray-800 pt-1 border-b border-gray-100 pb-2 mb-2">
                                <span>Delivery Subtotal</span>
                                <span id="dtlSelDelTotal">--</span>
                            </div>
                        </div>

                        <div class="space-y-1">
                            <div class="flex justify-between">
                                <span>Supply (On-Peak)</span>
                                <span id="dtlSelSupOn" class="font-mono">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Supply (Off-Peak)</span>
                                <span id="dtlSelSupOff" class="font-mono">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Merchant Function</span>
                                <span id="dtlSelMFC" class="font-mono">--</span>
                            </div>
                            <div class="flex justify-between border-t border-dashed border-gray-200 pt-1">
                                <span>Taxes & Surcharges (~7.0%)</span>
                                <span id="dtlSelSupTax" class="font-mono text-gray-500">--</span>
                            </div>
                            <div class="flex justify-between font-bold text-gray-800 pt-1 border-b border-gray-100 pb-2 mb-2">
                                <span>Supply Subtotal</span>
                                <span id="dtlSelSupTotal">--</span>
                            </div>
                        </div>

                         <div class="flex justify-between font-black text-lg text-blue-700 pt-1">
                            <span>Total Bill</span>
                            <span id="dtlSelTotal">--</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="text-xs font-bold uppercase text-gray-400 mb-2 border-b border-gray-100 pb-1">Standard Plan (Estimated)</h4>
                    <div class="space-y-1 text-sm text-gray-500">
                         <div class="flex justify-between">
                            <span>Delivery Subtotal</span>
                            <span id="dtlStdDelTotal" class="font-mono">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Supply Subtotal</span>
                            <span id="dtlStdSupTotal" class="font-mono">--</span>
                        </div>
                         <div class="flex justify-between font-bold text-gray-800 pt-1 border-t border-gray-200">
                            <span>Total</span>
                            <span id="dtlStdTotal">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 bg-gray-50 p-3 rounded-lg text-[10px] text-gray-500 leading-snug">
                <strong>How Select works:</strong> The "Demand Charge" is calculated from the average of your three highest 1-hour demands (measured separately for Peak and Off-Peak windows) during the billing period. In exchange for managing these peaks, you get significantly lower rates for your total energy usage.
            </div>
        </div>
    </div>
</div>

<script type="module">
    /** @const Seasonal Weights */
    const SEASON_WEIGHTS = [0.144, 0.124, 0.076, 0.048, 0.030, 0.041, 0.054, 0.038, 0.033, 0.050, 0.094, 0.171];
    const MONTH_NAMES = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    /** @const Actual 2025 Utility Bills (For Standard Plan Validation) */
    const HISTORY_2025 = [
        { date: "2/10/2025", period: "jan-feb", kwh: 5729, bill: 1890.57, monthIdx: 0 },
        { date: "3/12/2025", period: "feb-mar", kwh: 4016, bill: 1355.00, monthIdx: 1 },
        { date: "4/10/2025", period: "mar-apr", kwh: 1785, bill: 602.48, monthIdx: 2 },
        { date: "5/9/2025", period: "apr-may", kwh: 543, bill: 207.62, monthIdx: 3 },
        { date: "6/10/2025", period: "may-jun", kwh: 279, bill: 118.27, monthIdx: 4 },
        { date: "7/10/2025", period: "jun-jul", kwh: 882, bill: 335.80, monthIdx: 5 }, 
        { date: "8/8/2025", period: "jul-aug", kwh: 953, bill: 364.81, monthIdx: 6 }, 
        { date: "9/9/2025", period: "aug-sep", kwh: 435, bill: 171.46, monthIdx: 7 }, 
        { date: "10/8/2025", period: "sep-oct", kwh: 410, bill: 160.85, monthIdx: 8 }, 
        { date: "11/6/2025", period: "oct-nov", kwh: 1857, bill: 612.86, monthIdx: 9 },
        { date: "12/10/2025", period: "nov-dec", kwh: 5029, bill: 1743.66, monthIdx: 10 }
    ];

    /** @const Constants tuned to Dec 2025 Select Plan Actuals (Exact Match) */
    const CONST = {
        SC1_STD_FIXED: 20.00, SC1_SEL_FIXED: 30.28, 
        SBC_RATE: 0.00472,    // 0.472 cents/kWh
        
        // Exact Tax Calibrations derived from bill
        TAX_DELIVERY: 1.0951, // ~9.5%
        TAX_SUPPLY: 1.0702,   // ~7.0%
        
        STD_DELIVERY_KWH: 0.165, 
        SEL_DELIVERY_KWH: 0.00981, // 0.981 cents/kWh
        
        WINTER_DEMAND: 19.50, // Peak
        SUMMER_DEMAND: 26.50, // Peak Est
        DEMAND_OFF_PEAK: 7.48,// All Year
        
        MFC_RATE: 0.003733, // Merchant Function (~$24.44/6547)

        SUPPLY_STD_WINTER: 0.136, SUPPLY_STD_SUMMER: 0.170, 
        
        // Exact User Rates
        SUPPLY_SEL_ON: 0.22118, 
        SUPPLY_SEL_OFF: 0.09952 
    };

    let chartInstance = null;

    // Use roughly half the user's Dec 2025 profile as defaults
    const DEFAULT_STATE = {
        totalKwh: 3250, onPeakKwh: 666, offPeakKwh: 2584, 
        peakKw: 7.6, peakKwOff: 7.9, billMonth: 11
    };

    const state = new Proxy({ ...DEFAULT_STATE }, {
        set(target, prop, value) {
            const num = parseFloat(value);
            target[prop] = isNaN(num) ? 0 : num;
            
            if (prop === 'totalKwh') {
                target.onPeakKwh = Math.round(target.totalKwh * 0.205);
                target.offPeakKwh = target.totalKwh - target.onPeakKwh;
                document.getElementById('onPeakKwh').value = target.onPeakKwh;
                document.getElementById('offPeakKwh').value = target.offPeakKwh;
            }
            if (prop === 'peakKw' && Math.abs(target.peakKwOff - target.peakKw) < 0.1) {
                target.peakKwOff = target.peakKw;
                document.getElementById('peakKwOff').value = target.peakKw;
            }

            syncToUrl();
            render();
            return true;
        }
    });

    window.toggleDetails = function() {
        const modal = document.getElementById('detailsModal');
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
            renderDetails();
        } else {
            modal.classList.add('hidden');
        }
    };

    window.reset = function() {
        // Update DOM inputs
        Object.keys(DEFAULT_STATE).forEach(key => {
            const el = document.getElementById(key);
            if(el) el.value = DEFAULT_STATE[key];
        });
        
        // Update State
        Object.assign(state, DEFAULT_STATE);
        
        // Clear URL params (remove hash)
        history.replaceState(null, '', window.location.pathname);
        
        // Force rendering since Proxy set via Object.assign is subtle with dependent fields
        document.getElementById('onPeakKwh').value = state.onPeakKwh;
        document.getElementById('offPeakKwh').value = state.offPeakKwh;
        render();
    };

    function calculate(usage, monthIdx) {
        const isSummer = monthIdx >= 5 && monthIdx <= 8;
        const demandRate = isSummer ? CONST.SUMMER_DEMAND : CONST.WINTER_DEMAND;
        const stdSupplyRate = isSummer ? CONST.SUPPLY_STD_SUMMER : CONST.SUPPLY_STD_WINTER;
        
        // --- Standard Calculation ---
        const stdFixed = CONST.SC1_STD_FIXED;
        const stdDelVol = usage.totalKwh * (CONST.STD_DELIVERY_KWH + CONST.SBC_RATE);
        const stdDelPreTax = stdFixed + stdDelVol;
        const stdDelTotal = stdDelPreTax * CONST.TAX_DELIVERY;

        const stdSupVol = usage.totalKwh * stdSupplyRate;
        const stdMFC = usage.totalKwh * CONST.MFC_RATE;
        const stdSupPreTax = stdSupVol + stdMFC;
        const stdSupTotal = stdSupPreTax * CONST.TAX_SUPPLY;
        
        // --- Select Calculation ---
        const selFixed = CONST.SC1_SEL_FIXED;
        const demandPeakCost = usage.peakKw * demandRate;
        const demandOffCost = usage.peakKwOff * CONST.DEMAND_OFF_PEAK;
        const selDemandCost = demandPeakCost + demandOffCost;
        const selDelVol = usage.totalKwh * (CONST.SEL_DELIVERY_KWH + CONST.SBC_RATE);
        
        const selDelPreTax = selFixed + selDemandCost + selDelVol;
        const selDelTax = selDelPreTax * (CONST.TAX_DELIVERY - 1);
        const selDelTotal = selDelPreTax * CONST.TAX_DELIVERY;

        const selSupOn = usage.onPeakKwh * CONST.SUPPLY_SEL_ON;
        const selSupOff = usage.offPeakKwh * CONST.SUPPLY_SEL_OFF;
        const selMFC = usage.totalKwh * CONST.MFC_RATE;
        
        const selSupPreTax = selSupOn + selSupOff + selMFC;
        const selSupTax = selSupPreTax * (CONST.TAX_SUPPLY - 1);
        const selSupTotal = selSupPreTax * CONST.TAX_SUPPLY;

        return { 
            stdTotal: stdDelTotal + stdSupTotal, 
            selTotal: selDelTotal + selSupTotal,
            
            stdDel: stdDelTotal,
            stdSup: stdSupTotal,
            
            selDel: selDelTotal,
            selSup: selSupTotal,

            // Detailed breakdown
            details: {
                // Select
                selFixed, demandPeakCost, demandOffCost, selDemandCost, selDelVol, 
                selDelTax, selDelTotal,
                selSupOn, selSupOff, selMFC, selSupTax, selSupTotal,
                
                // Standard (Simplified)
                stdDelTotal, stdSupTotal
            }
        };
    }

    function renderDetails() {
        const cur = calculate(state, parseInt(state.billMonth));
        const fmt = (v) => `$${v.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        const det = cur.details;

        // Select Details
        document.getElementById('dtlSelFixed').textContent = fmt(det.selFixed);
        
        document.getElementById('dtlSelDemandRate').textContent = `${state.peakKw} kW @ $${(parseInt(state.billMonth) >= 5 && parseInt(state.billMonth) <= 8 ? CONST.SUMMER_DEMAND : CONST.WINTER_DEMAND).toFixed(2)}`;
        document.getElementById('dtlSelDemandTotal').textContent = fmt(det.demandPeakCost);

        document.getElementById('dtlSelDemandOffRate').textContent = `${state.peakKwOff} kW @ $7.48`;
        document.getElementById('dtlSelDemandOffTotal').textContent = fmt(det.demandOffCost);

        document.getElementById('dtlSelDelVol').textContent = fmt(det.selDelVol);
        document.getElementById('dtlSelDelTax').textContent = fmt(det.selDelTax);
        document.getElementById('dtlSelDelTotal').textContent = fmt(det.selDelTotal);

        document.getElementById('dtlSelSupOn').textContent = fmt(det.selSupOn);
        document.getElementById('dtlSelSupOff').textContent = fmt(det.selSupOff);
        document.getElementById('dtlSelMFC').textContent = fmt(det.selMFC);
        document.getElementById('dtlSelSupTax').textContent = fmt(det.selSupTax);
        document.getElementById('dtlSelSupTotal').textContent = fmt(det.selSupTotal);

        document.getElementById('dtlSelTotal').textContent = fmt(cur.selTotal);

        // Standard Details
        document.getElementById('dtlStdDelTotal').textContent = fmt(det.stdDelTotal);
        document.getElementById('dtlStdSupTotal').textContent = fmt(det.stdSupTotal);
        document.getElementById('dtlStdTotal').textContent = fmt(cur.stdTotal);
    }

    function render() {
        const cur = calculate(state, parseInt(state.billMonth));
        const savings = cur.stdTotal - cur.selTotal;
        const fmt = (v) => `$${v.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        const fmt0 = (v) => `$${v.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
        
        document.getElementById('stdDel').textContent = fmt(cur.stdDel);
        document.getElementById('stdSup').textContent = fmt(cur.stdSup);
        document.getElementById('stdTotal').textContent = fmt(cur.stdTotal);
        document.getElementById('stdEff').textContent = `$${(cur.stdTotal / (state.totalKwh || 1)).toFixed(3)}`;
        document.getElementById('selDel').textContent = fmt(cur.selDel);
        document.getElementById('selSup').textContent = fmt(cur.selSup);
        document.getElementById('selTotal').textContent = fmt(cur.selTotal);
        document.getElementById('selEff').textContent = `$${(cur.selTotal / (state.totalKwh || 1)).toFixed(3)}`;

        const savingsCard = document.getElementById('savingsCard');
        const savingsLabel = document.getElementById('savingsLabel');
        const savingsAmount = document.getElementById('savingsAmount');
        const savingsPercent = document.getElementById('savingsPercent');

        if (savings >= 0) {
            savingsCard.className = 'card bg-green-50 border-green-100 text-center';
            savingsLabel.className = 'text-[10px] font-bold uppercase text-green-600 mb-1';
            savingsLabel.textContent = 'Estimated Savings';
            savingsAmount.className = 'text-4xl font-black text-green-700';
            savingsAmount.textContent = fmt(savings);
            savingsPercent.className = 'text-xs font-bold text-green-600 mt-1 uppercase tracking-tight';
            savingsPercent.textContent = `${((savings/cur.stdTotal)*100).toFixed(1)}% SAVINGS`;
        } else {
            savingsCard.className = 'card bg-orange-50 border-orange-100 text-center';
            savingsLabel.className = 'text-[10px] font-bold uppercase text-orange-600 mb-1';
            savingsLabel.textContent = 'Extra Cost';
            savingsAmount.className = 'text-4xl font-black text-orange-700';
            savingsAmount.textContent = fmt(Math.abs(savings));
            savingsPercent.className = 'text-xs font-bold text-orange-600 mt-1 uppercase tracking-tight';
            savingsPercent.textContent = `${((Math.abs(savings)/cur.stdTotal)*100).toFixed(1)}% MORE EXPENSIVE`;
        }

        let yearStd = 0, yearSel = 0;
        const baseW = SEASON_WEIGHTS[state.billMonth] || 0.1; 
        const monthlyData = { labels: MONTH_NAMES, std: [], sel: [] };
        
        SEASON_WEIGHTS.forEach((w, i) => {
            const r = w / baseW;
            const scaledPeak = state.peakKw * Math.pow(r, 0.6);
            const scaledOff = state.peakKwOff * Math.pow(r, 0.6);
            
            const est = calculate({
                totalKwh: state.totalKwh * r, 
                onPeakKwh: state.onPeakKwh * r,
                offPeakKwh: state.offPeakKwh * r, 
                peakKw: scaledPeak,
                peakKwOff: scaledOff
            }, i);
            yearStd += est.stdTotal;
            yearSel += est.selTotal;
            monthlyData.std.push(est.stdTotal);
            monthlyData.sel.push(est.selTotal);
        });

        const annualSavings = yearStd - yearSel;
        const annualPct = (Math.abs(annualSavings) / yearStd) * 100;
        document.getElementById('yearlyStd').textContent = `$${yearStd.toLocaleString(undefined, {maximumFractionDigits:0})}`;
        document.getElementById('yearlySel').textContent = `$${yearSel.toLocaleString(undefined, {maximumFractionDigits:0})} / YEAR`;
        
        const yearlySavingsEl = document.getElementById('yearlySavings');
        if (annualSavings >= 0) {
            yearlySavingsEl.textContent = `${fmt0(annualSavings)} (${annualPct.toFixed(1)}%) SAVINGS`;
            yearlySavingsEl.className = 'text-right text-[10px] font-black text-green-600 pb-1 border-b-2 border-green-200';
        } else {
            yearlySavingsEl.textContent = `+${fmt0(annualSavings)} (${annualPct.toFixed(1)}%) EXTRA`;
            yearlySavingsEl.className = 'text-right text-[10px] font-black text-orange-600 pb-1 border-b-2 border-orange-200';
        }
        document.getElementById('baseMonthLabel').textContent = MONTH_NAMES[state.billMonth] || "Unknown";

        renderChart(monthlyData);
        if (!document.getElementById('detailsModal').classList.contains('hidden')) renderDetails();
    }

    function renderChart(data) {
        if (typeof Chart === 'undefined') return;
        const ctx = document.getElementById('annualChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Standard',
                        data: data.std,
                        borderColor: '#9ca3af',
                        backgroundColor: '#9ca3af',
                        borderWidth: 2,
                        pointRadius: 2,
                        tension: 0.4
                    },
                    {
                        label: 'Select Pricing',
                        data: data.sel,
                        borderColor: '#4285f4',
                        backgroundColor: '#4285f4',
                        borderWidth: 2,
                        pointRadius: 2,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: { display: false },
                    x: { grid: { display: false }, ticks: { font: { size: 8 } } }
                }
            }
        });
    }

    function syncToUrl() {
        const p = new URLSearchParams(state);
        window.history.replaceState(null, '', '#' + p.toString());
    }

    function toggleTestWindow() {
        let log = document.getElementById('testLog') || document.createElement('div');
        if (!log.id) {
            log.id = 'testLog';
            log.className = 'mt-4 p-4 bg-black text-green-400 font-mono text-[10px] rounded overflow-x-auto';
            document.querySelector('main').appendChild(log);
            runTests(log);
        } else {
            document.querySelector('main').removeChild(log);
        }
    }
    
    function runTests(log) {
        log.innerHTML = `> RUNNING VALIDATION...<br>`;
        const dec = calculate({
            totalKwh: 6547, onPeakKwh: 1344, offPeakKwh: 5203, 
            peakKw: 15.24, peakKwOff: 15.77 
        }, 11); 
        
        const decTarget = 1490.34;
        const diff = Math.abs(dec.selTotal - decTarget);
        const decPass = diff < 0.50; 
        log.innerHTML += `DEC '25 PROJ: ${dec.selTotal.toFixed(2)} (Target: ${decTarget}) [${decPass ? 'PASS' : 'FAIL'}]<br>`;
        if(!decPass) log.innerHTML += `<span class="text-red-400">Diff: $${diff.toFixed(2)}</span><br>`;

        log.innerHTML += `> CHECKING 2025 HISTORY...<br>`;
        HISTORY_2025.forEach(rec => {
            const est = calculate({ 
                totalKwh: rec.kwh, 
                onPeakKwh: rec.kwh * 0.2, 
                offPeakKwh: rec.kwh * 0.8,
                peakKw: 0, peakKwOff: 0
            }, rec.monthIdx);
            
            const diff = est.stdTotal - rec.bill;
            const pct = (diff / rec.bill) * 100;
            const color = Math.abs(pct) < 10 ? 'text-green-400' : 'text-yellow-500';
            log.innerHTML += `<span class="${color}">${rec.period}: Act $${rec.bill.toFixed(0)} vs Est $${est.stdTotal.toFixed(0)} (${pct > 0 ? '+' : ''}${pct.toFixed(1)}%)</span><br>`;
        });
        log.innerHTML += `> VALIDATION COMPLETE`;
    }

    window.onload = () => {
        const hash = window.location.hash.slice(1);
        if (hash) {
            const p = new URLSearchParams(hash);
            for (const [k, v] of p) {
                state[k] = v;
                const el = document.getElementById(k);
                if(el) el.value = v;
            }
        }
        render();
    };

    ['totalKwh', 'onPeakKwh', 'offPeakKwh', 'peakKw', 'peakKwOff', 'billMonth'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', (e) => state[id] = e.target.value);
    });
    document.getElementById('resetBtn').onclick = reset;
    document.getElementById('testBtn').onclick = toggleTestWindow;
</script>
</body>
</html>
