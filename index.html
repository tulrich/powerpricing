<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerPricing | ConEd Bill Estimator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --google-blue: #4285f4; }
        .card { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); border: 1px solid #f3f4f6; }
        .drag-active { border-color: #4285f4; background-color: #eff6ff; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms, transform 200ms; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans leading-relaxed">

<div id="app" class="max-w-md mx-auto min-h-screen flex flex-col p-4">
    <header class="mb-6 pt-2 text-center">
        <div class="bg-amber-50 border border-amber-100 rounded-lg p-3 mb-4 text-[11px] text-amber-800 leading-snug">
            <span class="font-bold">⚠️ Disclaimer:</span> Vibe-coded by a ConEd customer while making breakfast. No guarantee of accuracy, use at your own risk!
        </div>
        <h1 class="text-2xl font-bold text-gray-800">PowerPricing</h1>
        <p class="text-sm text-gray-500 font-medium">ConEd NYC 2026 Select Pricing Plan Estimator</p>
    </header>

    <main class="space-y-6 flex-grow">
        <section id="dropZone" class="card border-2 border-dashed border-gray-300 text-center cursor-pointer transition-colors hover:border-blue-400 hover:bg-gray-50 relative">
            <input type="file" id="fileInput" class="hidden" accept=".csv,.xml,.zip" multiple>
            <div class="space-y-2 pointer-events-none">
                <div class="text-2xl">⚡️</div>
                <p class="text-xs font-bold text-gray-500 uppercase">Upload ConEd Data</p>
                <p id="dropStatus" class="text-[10px] text-gray-400">Drop "Export usage" files here to accumulate history</p>
            </div>
            <button onclick="window.toggleHelp(event)" class="absolute top-2 right-2 text-gray-400 hover:text-blue-500 z-10 p-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
        </section>

        <section id="historyCard" class="card hidden border-blue-100 bg-blue-50/30">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xs font-bold uppercase tracking-wider text-blue-800">Data Profile</h2>
                <button onclick="window.clearData()" class="text-[10px] text-red-500 hover:text-red-700 underline">Clear Uploads</button>
            </div>
            <div class="h-48">
                <canvas id="historyChart"></canvas>
            </div>
            <p id="historyMeta" class="text-[9px] text-center text-gray-400 mt-2 italic">Blue = Verified (>20 days) • Gray = Partial/Gap</p>
        </section>

        <section class="card">
            <h2 class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-4">Usage Profile</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Base Period for Estimates</label>
                    <select id="billMonth" class="w-full p-2 bg-gray-50 border rounded-md font-sans text-sm">
                        </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Total Energy (kWh)</label>
                    <input type="number" id="totalKwh" value="3250" class="w-full p-2 bg-gray-50 border rounded-md font-mono text-lg">
                </div>
                
                <div>
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">On-Peak kWh</label>
                    <input type="number" id="onPeakKwh" value="666" class="w-full p-2 bg-gray-50 border rounded-md font-mono text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Off-Peak kWh</label>
                    <input type="number" id="offPeakKwh" value="2584" class="w-full p-2 bg-gray-50 border rounded-md font-mono text-sm">
                </div>
                
                <div>
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Peak Demand (kW)</label>
                    <input type="number" id="peakKw" value="7.6" step="0.1" class="w-full p-2 bg-gray-50 border rounded-md font-mono text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Off-Peak Demand (kW)</label>
                    <input type="number" id="peakKwOff" value="7.9" step="0.1" class="w-full p-2 bg-gray-50 border rounded-md font-mono text-sm">
                </div>
            </div>
        </section>

        <section class="card overflow-hidden !p-0">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 border-b">
                    <tr>
                        <th class="p-3 text-[10px] font-bold text-gray-500 uppercase">Itemized</th>
                        <th class="p-3 text-[10px] font-bold text-gray-500 uppercase text-right">Standard</th>
                        <th class="p-3 text-[10px] font-bold text-gray-500 uppercase text-right">Select</th>
                    </tr>
                </thead>
                <tbody class="divide-y text-xs">
                    <tr>
                        <td class="p-3 text-gray-600 font-medium">Delivery</td>
                        <td id="stdDel" class="p-3 text-right font-mono text-gray-500">--</td>
                        <td id="selDel" class="p-3 text-right font-mono text-blue-600">--</td>
                    </tr>
                    <tr>
                        <td class="p-3 text-gray-600 font-medium">Supply</td>
                        <td id="stdSup" class="p-3 text-right font-mono text-gray-500">--</td>
                        <td id="selSup" class="p-3 text-right font-mono text-blue-600">--</td>
                    </tr>
                    <tr class="bg-gray-50/50 font-bold">
                        <td class="p-3 text-gray-800">Total Bill</td>
                        <td id="stdTotal" class="p-3 text-right font-mono text-gray-800 text-sm">--</td>
                        <td id="selTotal" class="p-3 text-right font-mono text-blue-700 text-sm">--</td>
                    </tr>
                    <tr class="text-[9px] text-gray-400">
                        <td class="p-3 italic uppercase">Effective $/kWh</td>
                        <td id="stdEff" class="p-3 text-right font-mono">--</td>
                        <td id="selEff" class="p-3 text-right font-mono">--</td>
                    </tr>
                </tbody>
            </table>
            <div class="p-3 bg-gray-50 text-center border-t border-gray-100">
                <button onclick="window.toggleDetails()" class="text-[10px] font-bold text-blue-600 hover:text-blue-800 uppercase tracking-wider flex items-center justify-center gap-1 mx-auto">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    See Bill Details
                </button>
            </div>
        </section>

        <section id="savingsCard" class="card text-center transition-colors duration-300">
            <h2 id="savingsLabel" class="text-[10px] font-bold uppercase mb-1">Estimated Savings</h2>
            <div id="savingsAmount" class="text-4xl font-black">--</div>
            <p id="savingsPercent" class="text-xs font-bold mt-1 uppercase tracking-tight">--</p>
        </section>

        <section id="yearlyCard" class="card border-dashed border-2 border-gray-200 bg-gray-50/50">
            <h2 class="text-[10px] font-bold uppercase text-gray-400 mb-2">2026 Annual Projection</h2>
            <div class="h-48 mb-4">
                <canvas id="annualChart"></canvas>
            </div>
            <div class="flex justify-between items-end border-t border-gray-200 pt-3">
                <div>
                    <div id="yearlyStd" class="text-base text-gray-400 line-through">--</div>
                    <div id="yearlySel" class="text-xl font-black text-gray-800 tracking-tight">--</div>
                </div>
                <div id="yearlySavings" class="text-right text-[10px] font-black pb-1 border-b-2">--</div>
            </div>
            <p class="text-[9px] text-gray-400 mt-3 leading-tight italic">
                Extrapolated from <span id="baseMonthLabel" class="font-bold text-gray-500">December</span> profile.
            </p>
        </section>

        <div class="text-center">
            <a href="https://www.coned.com/en/accounts-billing/select-pricing-plan" target="_blank" class="inline-flex items-center gap-1 text-[10px] font-bold text-blue-600 hover:text-blue-800 uppercase tracking-wider bg-blue-50 px-3 py-1.5 rounded-full">
                <span>Learn about Select Pricing</span>
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
            </a>
        </div>
    </main>

    <footer class="py-8 text-center space-y-4">
        <div class="flex justify-center gap-4 text-[10px] text-gray-300">
            <button id="resetBtn" class="hover:text-gray-500 underline">Reset Defaults</button>
            <span>|</span>
            <button id="testBtn" class="hover:text-gray-500 underline">Run Validation Tests</button>
        </div>
        <div class="flex flex-col items-center gap-2 border-t border-gray-100 pt-6">
            <a href="https://github.com/tulrich/powerpricing" target="_blank" class="flex items-center gap-2 text-xs text-gray-500 hover:text-gray-800">
                <span>View on GitHub</span>
            </a>
        </div>
    </footer>
</div>

<div id="detailsModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Bill Breakdown</h3>
                <button onclick="window.toggleDetails()" class="text-gray-400 hover:text-gray-600 p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="detailsContent" class="space-y-6"></div>
            <div class="mt-6 bg-gray-50 p-3 rounded-lg text-[10px] text-gray-500 leading-snug">
                <strong>How Select works:</strong> The "Demand Charge" is calculated from the average of your three highest 1-hour demands, for Peak and Off Peak time ranges. Peak is noon-8pm on weekdays.
            </div>
        </div>
    </div>
</div>

<div id="helpModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden" onclick="window.toggleHelp(event)">
    <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6" onclick="event.stopPropagation()">
        <h3 class="text-sm font-bold text-gray-800 uppercase mb-3">How to get your data</h3>
        <p class="text-xs text-gray-600 mb-4 leading-relaxed">
            On the <a href="https://www.coned.com" target="_blank" class="text-blue-600 underline">coned.com</a> website:
        </p>
        <ol class="list-decimal pl-4 text-xs text-gray-600 space-y-2 mb-4">
            <li>Log into your account.</li>
            <li>Go to <strong>Account & Billing</strong> > <strong>Energy Insights</strong>.</li>
            <li>Scroll down to find <strong>"Green Button | Download my data"</strong>.</li>
            <li>Select "Export usage" (for detailed interval data) or "Bill Totals".</li>
            <li>Choose either <strong>CSV</strong> or <strong>XML</strong> format.</li>
	    <li>Choose a long time interval if you can - up to 1 year. You can also upload multiple files into this app and the data will get merged together.</li>
        </ol>
        <div class="text-center">
            <button onclick="window.toggleHelp(event)" class="bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-bold py-2 px-4 rounded-lg">Got it</button>
        </div>
    </div>
</div>

<script type="module">
    // --- Constants & Config ---
    const SEASON_WEIGHTS = [0.175, 0.135, 0.082, 0.053, 0.032, 0.043, 0.058, 0.043, 0.039, 0.057, 0.109, 0.174];
    const MONTH_NAMES = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    
    const CONST = {
        SC1_STD_FIXED: 20.00, SC1_SEL_FIXED: 30.28, 
        SBC_RATE: 0.00472, TAX_DELIVERY: 1.0951, TAX_SUPPLY: 1.0702,   
        STD_DELIVERY_KWH: 0.165, SEL_DELIVERY_KWH: 0.00981, 
        WINTER_DEMAND: 19.50, SUMMER_DEMAND: 26.50, DEMAND_OFF_PEAK: 7.48,
        MFC_RATE: 0.003733, 
        SUPPLY_STD_WINTER: 0.136, SUPPLY_STD_SUMMER: 0.170, 
        SUPPLY_SEL_ON: 0.22118, SUPPLY_SEL_OFF: 0.09952,
    };

    const DEFAULT_STATE = {
        totalKwh: 3250, onPeakKwh: 666, offPeakKwh: 2584,
        peakKw: 7.6, peakKwOff: 7.9, billMonth: '11'
    };

    // --- Globals ---
    let chartInstance = null;
    let historyChartInstance = null;
    let parsedMonthlyData = {};
    let globalIntervals = new Map();

    // --- Core Functions (Defined BEFORE use) ---
    function updateDOM(keys) {
        keys.forEach(k => { 
            const el = document.getElementById(k); 
            if(el) el.value = k.includes('Kwh') ? Math.round(state[k]) : parseFloat(state[k]).toFixed(2); 
        });
    }

    function initDropdown() {
        const monthSelect = document.getElementById('billMonth');
        if (!monthSelect) return;
        monthSelect.innerHTML = '';
        MONTH_NAMES.forEach((m, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = m;
            monthSelect.appendChild(opt);
        });
        
        if(Object.keys(parsedMonthlyData).length > 0) {
            Object.keys(parsedMonthlyData).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(k => {
                if(k === 'rolling') {
                    const opt = document.createElement('option');
                    opt.value = 'rolling';
                    opt.textContent = parsedMonthlyData[k].label;
                    monthSelect.prepend(opt);
                } else {
                    const opt = monthSelect.querySelector(`option[value="${k}"]`);
                    if(opt) {
                        const days = parsedMonthlyData[k].days;
                        const suffix = days < 28 ? ` (${days}d Partial)` : ` (${days}d)`;
                        opt.textContent = `✅ ${MONTH_NAMES[k]}${suffix}`;
                    }
                }
            });
        }
        monthSelect.value = state.billMonth;
    }

    function loadMonthFromHistory(key) {
        const data = parsedMonthlyData[key];
        if (!data) return;
        Object.assign(state, {
            totalKwh: data.totalKwh,
            onPeakKwh: data.onPeakKwh,
            offPeakKwh: data.offPeakKwh,
            peakKw: data.peakKw,
            peakKwOff: data.peakKwOff
        });
        updateDOM(['totalKwh', 'onPeakKwh', 'offPeakKwh', 'peakKw', 'peakKwOff']);
    }

    // --- State Proxy ---
    const state = new Proxy({ ...DEFAULT_STATE }, {
        set(target, prop, value) {
            if (prop === 'billMonth') target[prop] = value.toString();
            else target[prop] = parseFloat(value) || 0;

            if (prop === 'totalKwh' && Object.keys(parsedMonthlyData).length === 0) {
                target.onPeakKwh = Math.round(target.totalKwh * 0.205);
                target.offPeakKwh = target.totalKwh - target.onPeakKwh;
                updateDOM(['onPeakKwh', 'offPeakKwh']);
            }
            if (prop === 'billMonth' && parsedMonthlyData && parsedMonthlyData[target.billMonth]) {
                loadMonthFromHistory(target.billMonth);
            }
            syncToUrl();
            render();
            return true;
        }
    });

    // --- Calculations & Rendering ---
    function calculate(usage, monthKey) {
        let monthIdx = (monthKey === 'rolling') ? 0 : parseInt(monthKey);
        const isSummer = monthIdx >= 5 && monthIdx <= 8; 
        const demandRate = isSummer ? CONST.SUMMER_DEMAND : CONST.WINTER_DEMAND;
        const stdSupplyRate = isSummer ? CONST.SUPPLY_STD_SUMMER : CONST.SUPPLY_STD_WINTER;
        
        // Standard Plan Calculations
        const stdFixed = CONST.SC1_STD_FIXED;
        const stdDelVol = usage.totalKwh * (CONST.STD_DELIVERY_KWH + CONST.SBC_RATE);
        const stdDelTotal = (stdFixed + stdDelVol) * CONST.TAX_DELIVERY;
        
        const stdSupVol = usage.totalKwh * stdSupplyRate;
        const stdMFC = usage.totalKwh * CONST.MFC_RATE;
        const stdSupTotal = (stdSupVol + stdMFC) * CONST.TAX_SUPPLY;
        
        // Select Plan Calculations
        const selFixed = CONST.SC1_SEL_FIXED;
        const demandPeakCost = usage.peakKw * demandRate;
        const demandOffCost = usage.peakKwOff * CONST.DEMAND_OFF_PEAK;
        const selDelVol = usage.totalKwh * (CONST.SEL_DELIVERY_KWH + CONST.SBC_RATE);
        const selDelTotal = (selFixed + demandPeakCost + demandOffCost + selDelVol) * CONST.TAX_DELIVERY;

        const selSupOn = usage.onPeakKwh * CONST.SUPPLY_SEL_ON;
        const selSupOff = usage.offPeakKwh * CONST.SUPPLY_SEL_OFF;
        const selMFC = usage.totalKwh * CONST.MFC_RATE;
        const selSupTotal = (selSupOn + selSupOff + selMFC) * CONST.TAX_SUPPLY;

        return { 
            stdTotal: stdDelTotal + stdSupTotal, selTotal: selDelTotal + selSupTotal,
            stdDel: stdDelTotal, stdSup: stdSupTotal, selDel: selDelTotal, selSup: selSupTotal,
            details: {
                selFixed, demandPeakCost, demandOffCost, selDelVol, 
                selDelTotal, selSupOn, selSupOff, selMFC, selSupTotal,
                stdFixed, stdDelVol, stdSupVol, stdMFC, stdDelTotal, stdSupTotal
            }
        };
    }

    function renderDetails() {
        const cur = calculate(state, state.billMonth);
        const fmt = (v) => `$${v.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        const det = cur.details;
        let monthIdx = state.billMonth === 'rolling' ? 0 : parseInt(state.billMonth);
        const isSum = (monthIdx >= 5 && monthIdx <= 8);

        // Standard Rates for display
        const stdSupplyRate = isSum ? CONST.SUPPLY_STD_SUMMER : CONST.SUPPLY_STD_WINTER;
        const stdDeliveryRate = CONST.STD_DELIVERY_KWH + CONST.SBC_RATE;

        // Calculate Standard Plan Tax/Fees (Difference between Total and the raw components)
        const stdTax = (cur.stdDel - det.stdFixed - det.stdDelVol) + (cur.stdSup - det.stdSupVol - det.stdMFC);

        // Calculate Select Plan Tax/Fees
        const selTax = (cur.selDel - det.selFixed - det.demandPeakCost - det.demandOffCost - det.selDelVol) +
            (cur.selSup - det.selSupOn - det.selSupOff - det.selMFC);

        const html = `
            <div>
                <h4 class="text-xs font-bold uppercase text-blue-600 mb-2 border-b border-blue-100 pb-1">Select Pricing Plan</h4>
                <div class="space-y-2 text-sm text-gray-600">
                    <div class="space-y-1">
                        <div class="flex justify-between"><span>Basic Service Charge</span><span class="font-mono">${fmt(det.selFixed)}</span></div>
                    </div>
                    
                    <div class="bg-blue-50/50 p-2 rounded-lg space-y-1 my-2">
                        <div class="flex justify-between text-[11px] font-bold text-blue-800 uppercase tracking-wider mb-1">Demand Charges</div>
                        <div class="flex justify-between">
                            <span>Peak Demand</span>
                            <span class="text-[10px] text-gray-400 mt-0.5">${parseFloat(state.peakKw).toFixed(2)} kW @ $${isSum ? CONST.SUMMER_DEMAND.toFixed(2) : CONST.WINTER_DEMAND.toFixed(2)}</span>
                            <span class="font-mono font-bold text-blue-700">${fmt(det.demandPeakCost)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Off-Peak Demand</span>
                            <span class="text-[10px] text-gray-400 mt-0.5">${parseFloat(state.peakKwOff).toFixed(2)} kW @ $7.48</span>
                            <span class="font-mono font-bold text-blue-700">${fmt(det.demandOffCost)}</span>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <div class="flex justify-between">
                            <span>Delivery (Volumetric)</span>
                             <span class="text-[10px] text-gray-400 mt-0.5">${Math.round(state.totalKwh)} kWh @ $0.01453</span>
                             <span class="font-mono">${fmt(det.selDelVol)}</span>
                         </div>
                        
                        <div class="flex justify-between">
                            <span>Supply (On-Peak)</span>
                            <span class="text-[10px] text-gray-400 mt-0.5">${Math.round(state.onPeakKwh)} kWh @ $${CONST.SUPPLY_SEL_ON.toFixed(5)}</span>
                            <span class="font-mono">${fmt(det.selSupOn)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Supply (Off-Peak)</span>
                            <span class="text-[10px] text-gray-400 mt-0.5">${Math.round(state.offPeakKwh)} kWh @ $${CONST.SUPPLY_SEL_OFF.toFixed(5)}</span>
                            <span class="font-mono">${fmt(det.selSupOff)}</span>
                        </div>
                        <div class="flex justify-between"><span>Merchant Function Charge</span><span class="font-mono">${fmt(det.selMFC)}</span></div>
                        <div class="flex justify-between text-gray-400 italic"><span>Taxes & Surcharges</span><span class="font-mono">${fmt(selTax)}</span></div>
                    </div>
                    <div class="flex justify-between font-black text-lg text-blue-700 pt-1 border-t mt-2"><span>Total Bill</span><span>${fmt(cur.selTotal)}</span></div>
                </div>
            </div>
            <div class="mt-4">
                <h4 class="text-xs font-bold uppercase text-gray-400 mb-2 border-b border-gray-100 pb-1">Standard Plan</h4>
                <div class="space-y-2 text-sm text-gray-600">
                    <div class="bg-gray-50/50 p-2 rounded-lg space-y-1 mb-2">
                        <div class="flex justify-between"><span>Basic Service Charge</span><span class="font-mono">${fmt(det.stdFixed)}</span></div>
                        <div class="flex justify-between">
                            <span>Delivery</span>
                            <span class="text-[10px] text-gray-400 mt-0.5">${Math.round(state.totalKwh)} kWh @ $${stdDeliveryRate.toFixed(3)}</span>
                            <span class="font-mono">${fmt(det.stdDelVol)}</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <div class="flex justify-between">
                            <span>Supply Charge</span>
                            <span class="text-[10px] text-gray-400 mt-0.5">${Math.round(state.totalKwh)} kWh @ $${stdSupplyRate.toFixed(3)}</span>
                            <span class="font-mono">${fmt(det.stdSupVol)}</span>
                        </div>
                        <div class="flex justify-between"><span>Merchant Function Charge</span><span class="font-mono">${fmt(det.stdMFC)}</span></div>
                        <div class="flex justify-between text-gray-400 italic"><span>Taxes & Surcharges</span><span class="font-mono">${fmt(stdTax)}</span></div>
                    </div>
                    <div class="flex justify-between font-black text-lg text-gray-800 pt-1 border-t mt-2"><span>Total Bill</span><span>${fmt(cur.stdTotal)}</span></div>
                </div>
            </div>`;
            const content = document.getElementById('detailsContent');
            if(content) content.innerHTML = html;
        }

        function renderAnnualChart() {
            if (typeof Chart === 'undefined') return;
            const ctx = document.getElementById('annualChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            let refWeight = SEASON_WEIGHTS[11];
            if (state.billMonth !== 'rolling' && !isNaN(parseInt(state.billMonth))) {
                refWeight = SEASON_WEIGHTS[parseInt(state.billMonth)];
            }
        
            let yStd=0, ySel=0;
            let chartLabels = [], chartStd = [], chartSel = [], chartColors = [];
    
            MONTH_NAMES.forEach((m, i) => {
                let dataForMonth;
                let isReal = false;
    
                if (parsedMonthlyData[i] && parsedMonthlyData[i].days >= 20) {
                    dataForMonth = parsedMonthlyData[i];
                    isReal = true;
                } else {
                    const r = SEASON_WEIGHTS[i] / refWeight;
                    dataForMonth = {
                        totalKwh: state.totalKwh * r,
                        onPeakKwh: state.onPeakKwh * r,
                        offPeakKwh: state.offPeakKwh * r,
                        peakKw: state.peakKw * Math.pow(r, 0.6),
                        peakKwOff: state.peakKwOff * Math.pow(r, 0.6)
                    };
                }
    
                const est = calculate(dataForMonth, i.toString());
                yStd += est.stdTotal; 
                ySel += est.selTotal;
                
                chartLabels.push(m);
                chartStd.push(est.stdTotal);
                chartSel.push(est.selTotal);
                chartColors.push(isReal ? '#4285f4' : '#d1d5db'); 
            });
            
            const setTxt = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
            setTxt('yearlyStd', `$${yStd.toLocaleString(undefined, {maximumFractionDigits:0})}`);
            setTxt('yearlySel', `$${ySel.toLocaleString(undefined, {maximumFractionDigits:0})} / YEAR`);
            const ySav = yStd - ySel;
            const annualPct = (Math.abs(ySav) / yStd) * 100;
            const prefix = ySav >= 0 ? "SELECT PLAN SAVES" : "SELECT PLAN COSTS EXTRA";
            setTxt('yearlySavings', `${prefix} $${Math.abs(ySav).toLocaleString(undefined, { maximumFractionDigits: 0 })} (${annualPct.toFixed(1)}%)`);
            
            const realCount = Object.keys(parsedMonthlyData).filter(k=>parsedMonthlyData[k].days>=20).length;
            setTxt('baseMonthLabel', realCount > 0 ? `${realCount} Verified Months + Estimates` : (MONTH_NAMES[state.billMonth] || "Estimated"));
    
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { 
                    labels: chartLabels, 
                    datasets: [
                        { label: 'Standard', data: chartStd, backgroundColor: '#9ca3af', order: 2 },
                        { label: 'Select (Verified)', data: chartSel, backgroundColor: chartColors.map(c => c === '#4285f4' ? '#4285f4' : 'transparent'), borderColor: '#4285f4', borderWidth: {top:0, right:0, bottom:0, left:0}, order: 1 },
                        { label: 'Select (Estimated)', data: chartSel, backgroundColor: chartColors.map(c => c === '#d1d5db' ? '#d1d5db' : 'transparent'), order: 3 }
                    ] 
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: true, labels: { boxWidth: 10, font: { size: 10 } } }, tooltip: { mode: 'index', intersect: false } },
                    scales: { x: { stacked: false, grid: { display: false } }, y: { beginAtZero: true, display: false } }
                }
            });
        }

    function renderHistoryChart(monthlyData) {
        if (typeof Chart === 'undefined') return;
        const ctx = document.getElementById('historyChart').getContext('2d');
        if (historyChartInstance) historyChartInstance.destroy();

        const keys = Object.keys(monthlyData).filter(k => k !== 'rolling').sort((a,b)=>parseInt(a)-parseInt(b));
        const labels = keys.map(k => `${MONTH_NAMES[k]} (${monthlyData[k].days}d)`);
        
        historyChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'On-Peak', data: keys.map(k => monthlyData[k].onPeakKwh), backgroundColor: '#fcd34d', stack: '0' },
                    { label: 'Off-Peak', data: keys.map(k => monthlyData[k].offPeakKwh), backgroundColor: '#93c5fd', stack: '0' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true } },
                plugins: { legend: { display: true, position: 'top', labels: { boxWidth: 8, font: { size: 9 } } } }
            }
        });
    }

    function render() {
        if (!state.billMonth) state.billMonth = '11';
        const cur = calculate(state, state.billMonth);
        const savings = cur.stdTotal - cur.selTotal;
        const fmt = (v) => `$${v.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        const fmt0 = (v) => `$${v.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
        
        const setTxt = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };
        
        setTxt('stdDel', fmt(cur.stdDel));
        setTxt('stdSup', fmt(cur.stdSup));
        setTxt('stdTotal', fmt(cur.stdTotal));
        setTxt('stdEff', `$${(cur.stdTotal/(state.totalKwh||1)).toFixed(3)}`);
        setTxt('selDel', fmt(cur.selDel));
        setTxt('selSup', fmt(cur.selSup));
        setTxt('selTotal', fmt(cur.selTotal));
        setTxt('selEff', `$${(cur.selTotal/(state.totalKwh||1)).toFixed(3)}`);

        let monthIdx = state.billMonth === 'rolling' ? 0 : parseInt(state.billMonth);
        const isSum = (monthIdx >= 5 && monthIdx <= 8);

        const card = document.getElementById('savingsCard');
        const sl = document.getElementById('savingsLabel');
        const sa = document.getElementById('savingsAmount');
        const sp = document.getElementById('savingsPercent');

        if (savings >= 0) {
            card.className = 'card bg-green-50 border-green-100 text-center';
            sl.className = 'text-[10px] font-bold uppercase text-green-600 mb-1';
            sl.textContent = `Estimated Savings for ${state.billMonth === 'rolling' ? 'Rolling Year' : MONTH_NAMES[monthIdx]}`;
            sa.className = 'text-4xl font-black text-green-700';
            sa.textContent = fmt0(savings);
            sp.className = 'text-xs font-bold text-green-600 mt-1 uppercase tracking-tight';
            sp.textContent = `SELECT PLAN SAVES ${((savings / cur.stdTotal) * 100).toFixed(1)}%`;
        } else {
            card.className = 'card bg-orange-50 border-orange-100 text-center';
            sl.className = 'text-[10px] font-bold uppercase text-orange-600 mb-1';
            sl.textContent = `Extra Cost for ${state.billMonth === 'rolling' ? 'Rolling Year' : MONTH_NAMES[monthIdx]}`;
            sa.className = 'text-4xl font-black text-orange-700';
            sa.textContent = fmt0(Math.abs(savings));
            sp.className = 'text-xs font-bold text-orange-600 mt-1 uppercase tracking-tight';
            sp.textContent = `SELECT PLAN COSTS AN EXTRA ${((Math.abs(savings) / cur.stdTotal) * 100).toFixed(1)}%`;
        }

        renderAnnualChart();
        if (!document.getElementById('detailsModal').classList.contains('hidden')) renderDetails();
    }

    function syncToUrl() {
        if(Object.keys(parsedMonthlyData).length > 0) {
            const parts = [];
            Object.keys(parsedMonthlyData).filter(k=>k!=='rolling').forEach(k => {
                const d = parsedMonthlyData[k];
                if(d.days > 5) parts.push(`${k},${d.totalKwh},${d.onPeakKwh},${d.offPeakKwh},${d.peakKw},${d.peakKwOff},${d.days}`);
            });
            window.location.hash = 'data=' + parts.join('|');
        } else {
            const p = new URLSearchParams(state);
            window.history.replaceState(null, '', '#' + p.toString());
        }
    }

    function loadFromUrl() {
        const hash = window.location.hash.slice(1);
        if(hash.startsWith('data=')) {
            try {
                const raw = hash.split('data=')[1];
                raw.split('|').forEach(chunk => {
                    const p = chunk.split(',').map(Number);
                    if (p.length >= 7) {
                        parsedMonthlyData[p[0]] = {
                            totalKwh: p[1], onPeakKwh: p[2], offPeakKwh: p[3],
                            peakKw: p[4], peakKwOff: p[5], days: p[6], label: MONTH_NAMES[p[0]]
                        };
                    }
                });
                initDropdown();
                const keys = Object.keys(parsedMonthlyData).map(Number).sort((a,b)=>b-a);
                const fullMonth = keys.find(k => parsedMonthlyData[k].days >= 28);
                state.billMonth = (fullMonth !== undefined ? fullMonth : keys[0]).toString();
                
                document.getElementById('dropStatus').textContent = `✅ Loaded shared data (${Object.keys(parsedMonthlyData).length} months)`;
                document.getElementById('dropStatus').className = "text-[10px] text-green-600 font-bold";
                document.getElementById('historyCard').classList.remove('hidden');
                renderHistoryChart(parsedMonthlyData);
            } catch(e) { console.error(e); }
        } else if (hash) {
            const p = new URLSearchParams(hash);
            for (const [k, v] of p) {
                state[k] = v;
            }
        }
    }

    function processGlobalIntervals() {
        if(globalIntervals.size === 0) return;

        const intervals = Array.from(globalIntervals.entries())
            .map(([ts, kwh]) => ({ ts, kwh }))
            .sort((a,b) => a.ts - b.ts);

        const months = {};
        
        intervals.forEach(i => {
            const date = new Date(i.ts);
            const mKey = date.getMonth(); 
            if (!months[mKey]) months[mKey] = { raw: [], total: 0, onPeak: 0, offPeak: 0, days: new Set() };
            
            months[mKey].raw.push(i);
            months[mKey].days.add(date.toDateString());
            months[mKey].total += i.kwh; 
            
            const hour = date.getHours();
            const day = date.getDay();
            const isWeekday = (day >= 1 && day <= 5);
            const isSummer = (mKey >= 5 && mKey <= 8);

	    // TODO: also test for holidays. Holidays are off peak.
            const onPeak = isWeekday && hour >= 8 && hour < 22;
            if (onPeak) months[mKey].onPeak += i.kwh;
            else months[mKey].offPeak += i.kwh;
        });

        const getTop3Avg = (dict) => {
            const peaks = Object.values(dict).sort((a,b) => b - a).slice(0, 3);
            if (peaks.length === 0) return 0;
            return peaks.reduce((a,b) => a+b, 0) / peaks.length;
        };

        Object.keys(months).forEach(mIdx => {
            if(months[mIdx].days.size < 2) return;

            const m = months[mIdx];
            const readings = m.raw.sort((a,b) => a.ts - b.ts);
            const dayPeaks = { on: {}, off: {} };
	    const msPerHour = 3600000;

	    let nextI = 0;
            for (let i = 0; i < readings.length; i = nextI) {
		nextI = i + 1;

		// Compute the index of the hour that this sample corresponds to.
		const hourStartIndex = Math.floor(readings[i].ts / msPerHour);
		// Slide forward to select samples in the same hour.
		while (nextI < readings.length) {
		    const hourIndex = Math.floor(readings[nextI].ts / msPerHour);
		    if (hourIndex != hourStartIndex) {
			break;
		    }
		    nextI++;
		}
                const window = readings.slice(i, nextI);

                const avgKw = window.reduce((a, b) => a + b.kwh, 0); 
                const midTime = new Date(window[Math.floor((window.length - 1) / 2)].ts);
                const hour = midTime.getHours();
                const day = midTime.getDay();
                const isPeak = (day >= 1 && day <= 5) && (hour >= 8 && hour < 22);
                const target = isPeak ? dayPeaks.on : dayPeaks.off;
                const dayStr = midTime.toDateString();
                if (!target[dayStr] || avgKw > target[dayStr]) target[dayStr] = avgKw;
            }

            parsedMonthlyData[mIdx] = {
                totalKwh: Math.round(m.total),
                onPeakKwh: Math.round(m.onPeak),
                offPeakKwh: Math.round(m.offPeak),
                peakKw: parseFloat(getTop3Avg(dayPeaks.on).toFixed(2)),
                peakKwOff: parseFloat(getTop3Avg(dayPeaks.off).toFixed(2)),
                label: MONTH_NAMES[mIdx],
                days: m.days.size
            };
        });

        initDropdown();
        
        const keys = Object.keys(parsedMonthlyData).filter(k=>k!=='rolling').map(Number).sort((a,b)=>b-a);
        const fullMonth = keys.find(k => parsedMonthlyData[k].days >= 20);
        
        if (fullMonth !== undefined) state.billMonth = fullMonth.toString();
        else if (parsedMonthlyData['rolling']) state.billMonth = 'rolling';
        else if (keys.length) state.billMonth = keys[0].toString();

        renderHistoryChart(parsedMonthlyData);
        
        const count = Object.keys(parsedMonthlyData).filter(k=>k!=='rolling').length;
        const ds = document.getElementById('dropStatus');
        ds.textContent = `✅ Merged ${count} months. Total intervals: ${globalIntervals.size}`;
        ds.className = "text-[10px] text-green-600 font-bold";
        document.getElementById('historyCard').classList.remove('hidden');
        render(); 
    }

    async function handleFile(file) {
        const status = document.getElementById('dropStatus');
        status.textContent = "Processing " + file.name + "...";
        status.className = "text-[10px] text-blue-500 font-bold";

        try {
            let text = "";
            let isXml = file.name.endsWith('.xml');

            if (file.name.endsWith('.zip')) {
                const zip = await JSZip.loadAsync(file);
                // Get ALL CSV and XML files
                const validFiles = Object.values(zip.files).filter(f => !f.dir && (f.name.endsWith('.csv') || f.name.endsWith('.xml')));
                
                if (validFiles.length === 0) throw new Error("No CSV/XML found in ZIP");

                const promises = validFiles.map(async f => {
                    const text = await f.async("string");
                    if (f.name.endsWith('.xml')) parseIntervalXML(text);
                    else parseIntervalCSV(text);
                });
                
                await Promise.all(promises);
            } else {
                text = await file.text();
                if (!isXml && text.trim().startsWith("<?xml")) isXml = true;
                if (isXml) parseIntervalXML(text);
                else parseIntervalCSV(text);
            }
            
            processGlobalIntervals();

        } catch (e) {
            console.error(e);
            status.textContent = "❌ " + e.message;
            status.className = "text-[10px] text-red-500 font-bold";
        }
    }

    function parseIntervalCSV(csv) {
        const lines = csv.split('\n');
        let headerIdx = -1;
        let hParts = [];
        
        for (let i = 0; i < Math.min(lines.length, 20); i++) {
            const line = lines[i];
            // Header Hunt
            if (line.includes("START TIME") || (line.includes("TYPE") && line.includes("DATE"))) {
                headerIdx = i;
                hParts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.trim().replace(/"/g, ''));
                break;
            }
        }
        
        if (headerIdx === -1) return;

        const dateIdx = hParts.findIndex(h => h.includes("DATE") && !h.includes("END"));
        const timeIdx = hParts.findIndex(h => h.includes("START TIME"));
        let usageIdx = hParts.findIndex(h => h === "USAGE" || h.includes("USAGE (kWh)"));
        const importIdx = hParts.findIndex(h => h.includes("IMPORT"));
        const exportIdx = hParts.findIndex(h => h.includes("EXPORT"));
        
        for (let i = headerIdx + 1; i < lines.length; i++) {
            const line = lines[i];
            if (!line.trim()) continue;
            const p = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); 
            if (p.length < 4) continue;
            
            const clean = (s) => parseFloat(s ? s.replace(/[",]/g, '') : 0);
            let kwh = 0;

            if (usageIdx !== -1) kwh = clean(p[usageIdx]);
            else if (importIdx !== -1 && exportIdx !== -1) kwh = clean(p[importIdx]) - clean(p[exportIdx]);
            else if (p.length >= 5) kwh = clean(p[4]); 

            if (!isNaN(kwh) && p[dateIdx] && p[timeIdx]) {
                const ts = new Date(`${p[dateIdx]}T${p[timeIdx]}`).getTime();
                if(!isNaN(ts)) globalIntervals.set(ts, kwh);
            }
        }
    }

    function parseIntervalXML(xml) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(xml, "text/xml");
        const readings = Array.from(doc.getElementsByTagName("IntervalReading"));
        if (!readings.length) return;
        
        const temp = [];
        readings.forEach(r => {
            const valNode = r.getElementsByTagName("value")[0];
            const timeNode = r.getElementsByTagName("timePeriod")[0];
            const startNode = timeNode ? timeNode.getElementsByTagName("start")[0] : null;
            if (valNode && startNode) {
                temp.push({ ts: parseInt(startNode.textContent) * 1000, val: parseInt(valNode.textContent) });
            }
        });
        
        const nonZeros = temp.filter(i => i.val > 0);
        const avg = nonZeros.length ? nonZeros.reduce((a,b) => a+b.val, 0) / nonZeros.length : 0;
        const multiplier = avg > 10 ? 0.001 : 1; 

        temp.forEach(i => globalIntervals.set(i.ts, i.val * multiplier));
    }

    // --- Global Helpers ---
    window.toggleHelp = function(e) {
        if(e) e.stopPropagation();
        document.getElementById('helpModal').classList.toggle('hidden');
    };

    window.toggleDetails = function() {
        const modal = document.getElementById('detailsModal');
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
            renderDetails();
        } else {
            modal.classList.add('hidden');
        }
    };

    window.clearData = function() {
        parsedMonthlyData = {};
        globalIntervals.clear();
        initDropdown();
        
        Object.keys(DEFAULT_STATE).forEach(key => {
            if (key !== 'billMonth') state[key] = DEFAULT_STATE[key];
        });
        state.billMonth = '11';
        updateDOM(Object.keys(DEFAULT_STATE));

        document.getElementById('historyCard').classList.add('hidden');
        const ds = document.getElementById('dropStatus');
        ds.textContent = "Drop \"Export usage\" files here to accumulate history";
        ds.className = "text-[10px] text-gray-400";
        history.replaceState(null, '', window.location.pathname);
    };
    
    // --- Window Assignments ---
    window.reset = function() { window.clearData(); };
    window.toggleDetails = toggleDetails;
    window.toggleHelp = toggleHelp;

    window.onload = () => {
        initDropdown();
        loadFromUrl();
        render();
    };

    ['totalKwh', 'onPeakKwh', 'offPeakKwh', 'peakKw', 'peakKwOff', 'billMonth'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', (e) => state[id] = e.target.value);
    });
    
    const dropZone = document.getElementById('dropZone');
    if (dropZone) {
        dropZone.addEventListener('click', (e) => {
            if (e.target !== fileInput && !e.target.closest('button')) {
                fileInput.click();
            }
        });
        
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-active'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-active'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-active');
            if(e.dataTransfer.files.length) {
                Array.from(e.dataTransfer.files).forEach(f => handleFile(f));
            }
        });
    }

    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.addEventListener('change', (e) => { 
            Array.from(e.target.files).forEach(f => handleFile(f)); 
        });
    }

    const resetBtn = document.getElementById('resetBtn');
    if (resetBtn) {
        resetBtn.onclick = window.clearData;
    }
</script>
</body>
</html>
